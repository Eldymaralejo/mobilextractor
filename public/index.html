<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Social Preserve — Convert without killing quality</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 20px; max-width: 900px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    label { display:block; margin-top:8px; }
    input[type=file] { display:block; margin-top:8px; }
    select, input[type=number], input[type=text] { padding:6px; width:100%; box-sizing:border-box; }
    button { padding:10px 14px; margin-top:12px; }
    .progress { height:10px; background:#eee; border-radius:6px; overflow:hidden; margin-top:8px;}
    .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#4caf50,#8bc34a); transition:width .2s; }
    .note { color:#666; font-size:0.9rem; margin-top:6px; }
    .small { font-size:0.9rem; color:#444; }
  </style>
</head>
<body>
  <h1>Social Preserve</h1>
  <p class="note">Upload a photo or video → choose platform or custom settings → convert → download and install to your device.</p>

  <div class="card">
    <label>Choose media (image or video)</label>
    <input id="file" type="file" accept="video/*,image/*"/>
    <div id="fileInfo" class="small"></div>
  </div>

  <div class="card" id="platformCard">
    <label>Choose target platform</label>
    <select id="platformSelect"></select>
    <div id="presetDesc" class="note"></div>

    <label>Or use custom settings (optional)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:8px;">
      <div>
        <label>Width (px)</label>
        <input id="customWidth" type="number" min="1">
      </div>
      <div>
        <label>Height (px)</label>
        <input id="customHeight" type="number" min="1">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
      <div>
        <label>FPS</label>
        <input id="customFps" type="number" min="1" value="30">
      </div>
      <div>
        <label>Video bitrate (kbps)</label>
        <input id="customVbr" type="number" min="1" value="5000">
      </div>
    </div>

    <button id="uploadBtn">Upload & Start Conversion</button>
  </div>

  <div class="card" id="progressCard" style="display:none;">
    <div><strong>Job</strong> <span id="jobId"></span></div>
    <div class="progress"><i id="progressBar"></i></div>
    <div id="progressText" class="small">Waiting...</div>
    <div id="downloadArea" style="margin-top:12px;"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let socketId = null;
    socket.on('connect', () => {
      socket.emit('register');
    });
    socket.on('registered', (d) => { socketId = d.socketId; console.log('socketId', socketId); });

    // load presets
    let presets = {};
    fetch('/api/presets').then(r => r.json()).then(data => {
      presets = data;
      const sel = document.getElementById('platformSelect');
      Object.keys(presets).forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = presets[key].display;
        sel.appendChild(opt);
      });
      sel.value = 'instagram_reel';
      updatePresetDesc();
    });

    document.getElementById('platformSelect').addEventListener('change', updatePresetDesc);
    function updatePresetDesc() {
      const key = document.getElementById('platformSelect').value;
      const p = presets[key];
      if (!p) return;
      document.getElementById('presetDesc').textContent = p.description + ' Recommended: ' + JSON.stringify(p.recommended);
      // prefill custom inputs
      document.getElementById('customWidth').value = p.recommended.width;
      document.getElementById('customHeight').value = p.recommended.height;
      document.getElementById('customFps').value = p.recommended.fps;
      document.getElementById('customVbr').value = p.recommended.video_bitrate_kbps;
    }

    let chosenFile = null;
    document.getElementById('file').addEventListener('change', (e) => {
      const f = e.target.files[0];
      chosenFile = f;
      document.getElementById('fileInfo').textContent = f ? `${f.name} — ${Math.round(f.size/1024)} KB` : '';
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!chosenFile) return alert('Please pick a file first.');
      // upload
      const form = new FormData();
      form.append('media', chosenFile);
      const up = await fetch('/api/upload', { method: 'POST', body: form });
      const upj = await up.json();
      if (!upj.jobId) return alert('Upload failed');
      const jobId = upj.jobId;
      startProcessingUI(jobId);

      // start processing
      const custom = {
        width: Number(document.getElementById('customWidth').value),
        height: Number(document.getElementById('customHeight').value),
        fps: Number(document.getElementById('customFps').value),
        video_bitrate_kbps: Number(document.getElementById('customVbr').value)
      };
      await fetch('/api/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jobId, targetPlatform: document.getElementById('platformSelect').value, custom, socketId })
      });
    });

    function startProcessingUI(jobId) {
      document.getElementById('progressCard').style.display = 'block';
      document.getElementById('jobId').textContent = jobId;
      document.getElementById('progressText').textContent = 'Queued...';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('downloadArea').innerHTML = '';
    }

    socket.on('processing_started', (d) => {
      if (d.jobId) {
        document.getElementById('progressText').textContent = 'Started';
      }
    });
    socket.on('processing_progress', (d) => {
      // progress object has percent in some cases or frames/time
      const p = d.progress || {};
      let pct = p.percent || 0;
      if (!pct && p.timemark) {
        // approximate — not exact
        pct = Math.min(98, Math.floor(Math.random()*30 + 20));
      }
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressText').textContent = 'Progress: ' + JSON.stringify(p).slice(0,120);
    });
    socket.on('processing_done', (d) => {
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('progressText').textContent = 'Done — click to download';
      const a = document.createElement('a');
      a.href = d.url;
      a.textContent = `Download ${d.outName}`;
      a.style.display = 'inline-block';
      a.style.marginTop = '8px';
      a.className = 'downloadLink';
      document.getElementById('downloadArea').appendChild(a);

      // small instructions for installing on phone:
      const note = document.createElement('div');
      note.className = 'note';
      note.innerHTML = '<strong>Install tip:</strong> on Android: tap download to save then "Open with Gallery" or move to Camera folder. On iPhone: download and use "Save to Files" then add to Photos or import via computer.';
      document.getElementById('downloadArea').appendChild(note);
    });
    socket.on('processing_error', (d) => {
      document.getElementById('progressText').textContent = 'Error: ' + (d.message || 'unknown');
    });
  </script>
</body>
</html>
